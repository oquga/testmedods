# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã

```shell
go run main.go
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**

‚úÖ Go <br />
‚úÖ JWT<br />
‚ùå üêò PostgreSQL: —è –ø—Ä–æ—Å—Ç–æ –∑–∞–±—ã–ª —á—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –°–£–ë–î, –∏ –ø–æ—Å—Ç–∞—Ä–∞–ª—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö —Å–∞–º. <br />
‚ùå üê≥ Docker: —Ö–æ—Ç–µ–ª –æ–±–µ—Ä–Ω—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–æ –Ω–∞ macOS –æ–Ω –ø–µ—Ä–µ—Å—Ç–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å "rosetta error", –≤–∏–¥–∏–º–æ –∏–∑-–∑–∞ apple CPU <br />

![docker error](img/image.png "Docker error")

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

- Access —Ç–æ–∫–µ–Ω —Ç–∏–ø JWT, –∞–ª–≥–æ—Ä–∏—Ç–º SHA512, —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑–µ —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

```go
type AuthorizedUser struct {
    uuid       string
    email      string
    ip         string
    aExpiresAt int64
    rToken     string
    rExpiresAt int64
    revoked    string
}
```

–í –±–∞–∑–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–≤–∞ —Ç–æ–∫–µ–Ω–∞ —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∑–∞—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π rerfreshToken (rToken string) –∏ –ù–ï —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π refresh token (revoked string).

- Refresh —Ç–æ–∫–µ–Ω —Ç–∏–ø –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π, —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–µ–¥–∞—á–∏ base64, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –≤–∏–¥–µ bcrypt —Ö–µ—à–∞.

```go
rtClaims := jwt.NewWithClaims(jwt.SigningMethodHS512, jwt.MapClaims{
    "email": user.Email,
    "ip":    user.Ip,
    "iss":   currentTime.Unix(),
})
```

- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

```go
if storage.GetRevokedStatus(currentUser) == rTokenString {
    fmt.Fprintf(w, "Old Token is used to refresh one more time\n")
    fmt.Fprintf(w, "All authorized sessions of that user will be ended\n")
    storage.DeleteAuthorizedUser(currentUser)
    return
}
```

–ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã–º —Ç–æ–∫–µ–Ω–æ–º, —Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–¥–∞–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ uuid, —á—Ç–æ–±—ã –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è –ø–æ –Ω–æ–≤–æ–π.

- Access, Refresh —Ç–æ–∫–µ–Ω—ã –æ–±–æ—é–¥–Ω–æ —Å–≤—è–∑–∞–Ω—ã, Refresh –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è Access —Ç–æ–∫–µ–Ω–∞ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–º Refresh —Ç–æ–∫–µ–Ω–æ–º –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –≤—ã–¥–∞–Ω –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º.

```go
if !utils.CheckTokenHash(rTokenString, storage.GetRefreshToken(currentUser)) {
        fmt.Fprintf(w, "Refresh Token not credential")
        return
    } else {
        refreshedUser := storage.UserDTO{
            Uuid:  storage.GetUUID(currentUser),
            Email: storage.GetEmail(currentUser),
            Ip:    storage.GetIP(currentUser),   
        }
```

–í –¥–∞–Ω–Ω–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ –∫–æ–¥–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è refresh token –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∞–ª—Å—è –≤ –∫—É–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ refresh token –∑–∞—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

- Payload —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –æ–± ip –∞–¥—Ä–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –±—ã–ª –≤—ã–¥–∞–Ω. –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ ip –∞–¥—Ä–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–∏ —Ä–µ—Ñ—Ä–µ—à –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø–æ—Å–ª–∞—Ç—å email warning –Ω–∞ –ø–æ—á—Ç—É —é–∑–µ—Ä–∞ (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ).

```go
authClaims := jwt.NewWithClaims(jwt.SigningMethodHS512, jwt.MapClaims{
    "sub":   user.Uuid,
    "email": user.Email,
    "ip":    user.Ip,
    "iss":   currentTime.Unix(),
})

rtClaims := jwt.NewWithClaims(jwt.SigningMethodHS512, jwt.MapClaims{
    "email": user.Email,
    "ip":    user.Ip,
    "iss":   currentTime.Unix(),
})
```

–û–±–∞ —Ç–æ–∫–µ–Ω–∞ —Å–æ–¥–µ—Ä–∞–∂–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ –µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ß—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è email –æ—Ç–ø—Ä–∞–≤–∫–∏,–ø—ã—Ç–∞–ª—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ gmail, –Ω–æ –¥–æ—Å—Ç—É–ø —Ç—Ä–µ—Ç—å–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º —Å—Ç–∞–ª deprecated. –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ç—É—Ç–æ—Ä–∏–∞–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∏–º–µ—Ä —Å gmail, —Ç–∞–∫–∂–µ –ø—ã—Ç–∞–ª—Å—è —Ä–µ–ª–∏–∑–æ–≤–∞—Ç—å mailin, –Ω–æ —Ç–æ—Ç —Ç—Ä–µ–±–æ–≤–∞–ª —Ö–æ—Å—Ç–∞ —á—Ç–æ–±—ã –ø–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –±—ã–ª–æ –æ—Ç–ø–∞—Ä–≤–ª–µ–Ω–æ.